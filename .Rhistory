library(devtools)
library(roxygen2)
usethis::use_gpl3_license("Philip S. Boonstra")
pkgbuild::compile_dll()
devtools::load_all()
devtools::document()
devtools::build_vignettes()
devtools::build_manual()
devtools::document()
?seamlesssim
devtools::build_manual()
devtools::check()
devtools::check()
devtools::build()
install.packages("/Users/ecchase/Desktop/Research/Phil TITE-CRM/Package Development/seamlesssim_0.0.0.9000.tar.gz", repos=NULL)
library(seamlesssim)
?seamlesssim
?sim_3pl3
?bayesian_isotonic
vignette(package="seamlesssim")
RShowDoc(*, package="seamlesssim")
RShowDoc(package="seamlesssim")
RShowDoc(package="seamlesssim", type="pdf")
RShowDoc("vignette.pdf", package="seamlesssim", type="pdf")
library(knitr)
opts_chunk$set(collapse=TRUE, fig.align='center', tidy=TRUE, tidy.opts=list(blank=TRUE, width.cutoff=40), warning=FALSE,message=FALSE)
rm(list=ls())
library(tidyverse)
library(gridExtra)
library(RColorBrewer)
library(tableone)
library(latex2exp)
library(cmprsk)
library(survminer)
library(survival)
library(cowplot)
library(haven)
library(MatchIt)
setwd("~/Desktop/Research/Dan Prostate Race")
decipher <- read_csv('decipher_data.csv')
source("functions.R")
cutTime <- 120   #10 yr cutoff point
decipher$AA <- ifelse(decipher$selfreported_race == "African American", "AfA", "non-AfA")
decipher$AA_mc <- ifelse(decipher$signature_race == "African American", "AfA", "non-AfA")
decipher$met_time_10yr = ifelse(decipher$met_time > cutTime, cutTime, decipher$met_time)
decipher$met_status = ifelse(decipher$met_time >= cutTime, 0, decipher$met)
decipher$bcr_time_10yr = ifelse(decipher$bcr_time > cutTime, cutTime, decipher$bcr_time)
decipher$bcr_status = ifelse(decipher$bcr_time >= cutTime, 0, decipher$bcr)
dat <- decipher[, c("met_status", "met_time_10yr", "os", "AA")]
dat <- dat[complete.cases(dat), ]
dat_mc <- decipher[, c("met_status", "met_time_10yr", "os", "AA_mc")]
dat_mc <- dat_mc[complete.cases(dat_mc), ]
datci <- createCumIncFrame(data = dat,
event.D = met_status, event.T = met_time_10yr,
death.status = os,
group = AA, time.seq = seq(0, 120, by = 0.5),
risk.seq = seq(0, 120, by = 1))
datci.plot <- plotCumInc(c.frame = datci,
event.table = TRUE,
time.seq = seq(0, 120, 10),
risk.seq = c(0, 40, 80, 120),
pval.show = FALSE,
event.seq = c(40, 80, 120),
ylim = c(0, 50),
legend.xy = c(0.15, 0.8),
col = c("mediumpurple4", "gray74"),
event.ci = FALSE,
names = c("Decipher: Cumulative Incidence of Metastases", "Time (Months)",
"Risk (%)", "Self-reported race",
"Number of patients at risk", "Event rate"))
plot_grid(datci.plot$gp, datci.plot$gr, ncol = 1, align = "v", rel_heights = c(5.6, 2.2))
dat1 <- decipher[, c("bcr_status", "bcr_time_10yr", "os", "AA")]
dat1 <- dat1[complete.cases(dat1), ]
datci_bcr <- createCumIncFrame(data = dat1,
event.D = bcr_status, event.T = bcr_time_10yr,
death.status = os,
group = AA, time.seq = seq(0, 120, by = 0.5),
risk.seq = seq(0, 120, by = 0.5))
datci_bcr.plot <- plotCumInc(c.frame = datci_bcr,
event.table = TRUE,
time.seq = seq(0, 120, 10),
pval.show = FALSE,
risk.seq = c(0, 40, 80, 120),
event.seq = c(40, 80, 120),
ylim = c(0, 50),
legend.xy = c(0.15, 0.8),
col = c("mediumpurple4", "gray74"),
event.ci = FALSE,
names = c("Decipher: Cumulative Incidence of Biochemical Recurrence", "Time (Months)", "Risk (%)", "Self-reported race", "Number of patients at risk", "Event rate"))
plot_grid(datci_bcr.plot$gp, datci_bcr.plot$gr, ncol = 1, align = "v", rel_heights = c(5.6, 2.2))
datci <- createCumIncFrame(data = dat_mc,
event.D = met_status, event.T = met_time_10yr,
death.status = os,
group = AA_mc, time.seq = seq(0, 120, by = 0.5),
risk.seq = seq(0, 120, by = 1))
datci.plot <- plotCumInc(c.frame = datci,
event.table = TRUE,
time.seq = seq(0, 120, 10),
risk.seq = c(0, 40, 80, 120),
pval.show = FALSE,
event.seq = c(40, 80, 120),
ylim = c(0, 50),
legend.xy = c(0.15, 0.8),
col = c("mediumpurple4", "gray74"),
event.ci = FALSE,
names = c("Decipher: Cumulative Incidence of Metastases", "Time (Months)",
"Risk (%)", "Model signature race",
"Number of patients at risk", "Event rate"))
plot_grid(datci.plot$gp, datci.plot$gr, ncol = 1, align = "v", rel_heights = c(5.6, 2.2))
dat1_mc <- decipher[, c("bcr_status", "bcr_time_10yr", "os", "AA_mc")]
dat1_mc <- dat1_mc[complete.cases(dat1_mc), ]
datci_bcr <- createCumIncFrame(data = dat1_mc,
event.D = bcr_status, event.T = bcr_time_10yr,
death.status = os,
group = AA_mc, time.seq = seq(0, 120, by = 0.5),
risk.seq = seq(0, 120, by = 0.5))
datci_bcr.plot <- plotCumInc(c.frame = datci_bcr,
event.table = TRUE,
time.seq = seq(0, 120, 10),
pval.show = FALSE,
risk.seq = c(0, 40, 80, 120),
event.seq = c(40, 80, 120),
ylim = c(0, 50),
legend.xy = c(0.15, 0.8),
col = c("mediumpurple4", "gray74"),
event.ci = FALSE,
names = c("Decipher: Cumulative Incidence of Biochemical Recurrence", "Time (Months)", "Risk (%)", "Model signature race", "Number of patients at risk", "Event rate"))
plot_grid(datci_bcr.plot$gp, datci_bcr.plot$gr,  ncol = 1, align = "v", rel_heights = c(5.6, 2.2))
seerdata <- read_csv("~/Box/Dan Race Project/seer_short.csv")
seerdata2 <- filter(seerdata, n0==1, m0==1, yearofdiagnosis >= 2010, p_upstag_posmarg==1)
seerdata3 <- select(seerdata2, int_black_adjRT, black, survivalmonths, pcsm, ageatdiagnosis, rt_adj,
yost_index_1000, medicaid, uninsured, insuranceunknown)
rm(list=c("seerdata", "seerdata2"))
mydat <- cbind(seerdata3$int_black_adjRT, seerdata3$black, seerdata3$ageatdiagnosis, seerdata3$rt_adj, seerdata3$yost_index_1000, seerdata3$medicaid, seerdata3$uninsured, seerdata3$insuranceunknown)
colnames(mydat) <- c("Interaction", "Black", "Age", "RT", "Yost", "Medicaid", "Uninsured", "Unknown")
int_model <- crr(ftime = seerdata3$survivalmonths, fstatus = seerdata3$pcsm, cov1 = mydat)
mydat <- cbind(seerdata3$int_black_adjRT, seerdata3$black, seerdata3$ageatdiagnosis, seerdata3$rt_adj, seerdata3$yost_index_1000, seerdata3$medicaid, seerdata3$uninsured, seerdata3$insuranceunknown)
colnames(mydat) <- c("Interaction", "Black", "Age", "RT", "Yost", "Medicaid", "Uninsured", "Unknown")
int_model <- crr(ftime = seerdata3$survivalmonths, fstatus = seerdata3$pcsm, cov1 = mydat)
mydat <- mydat[complete.cases(mydat),]
meanage <- mean(mydat[,"Age"])
meanyost <- mean(mydat[, "Yost"])
black_adj <- c(1, 1, meanage, 1, meanyost, 0, 0, 0)
black_noadj <- c(0, 1, meanage, 0, meanyost, 0, 0, 0)
white_adj <- c(0, 0, meanage, 1, meanyost, 0, 0, 0)
white_noadj <- c(0, 0, meanage, 0, meanyost, 0, 0, 0)
pred_cov <- rbind(black_adj, black_noadj, white_adj, white_noadj)
colnames(pred_cov) <- c("Interaction", "Black", "Age", "RT", "Yost", "Medicaid", "Uninsured", "Unknown")
predinc <- predict(int_model, cov1=pred_cov)
predinc <- rbind(c(0, 0, 0, 0, 0), predinc)
View(predinc)
pcsm_5yr <- predinc[which(predinc[1,]==60),]
View(pcsm_5yr)
pcsm_5yr <- predinc[which(predinc[,1]==60),]
pcsm_5yr <- predinc[which(predinc[,1]==60), -1]
pcsm_5yr_dat <- data.frame("Incidence" = pcsm_5yr, "Black" = c(1, 1, 0, 0), "RT" = c("RT", "No RT", "RT", "No RT"))
View(pcsm_5yr_dat)
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_bar()
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_col()
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, group=Black, fill=Black)) + geom_col()
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_col(position="dodge")
int_plot
pcsm_5yr_dat$Black <- factor(pcsm_5yr_dat$Black, levels=c(0, 1), labels=c("non-AfA", "AfA"))
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_col(position="dodge")
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_col(position="dodge") + scale_color_manual("Self-reported race", values = c("gray74", "mediumpurple4"))
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_col(position="dodge") + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4"))
int_plot
pcsm_5yr_dat$Black <- factor(pcsm_5yr_dat$Black, levels=c(0, 1), labels=c("non-AfA", "AfA"))
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_col(position="dodge") + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("Cumulative Incidence of PCSM") + b.theme
b.theme <- theme_minimal(base_size = 15)
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_col(position="dodge") + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("Cumulative Incidence of PCSM") + b.theme
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_col(position="dodge") + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("Cumulative Incidence of PCSM") + theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("SEER: Interaction Between RT and Race for PCSM")
int_plot
pcsm_5yr <- predinc[which(predinc[,1]==60), -1]
pcsm_5yr_dat <- data.frame("Incidence" = pcsm_5yr, "Black" = c(1, 1, 0, 0), "RT" = c("RT", "No RT", "RT", "No RT"))
pcsm_5yr_dat$Black <- factor(pcsm_5yr_dat$Black, levels=c(0, 1), labels=c("non-AfA", "AfA"))
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_col(position="dodge") + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("Cumulative Incidence of PCSM") + theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("SEER: Interaction Between RT and Race for PCSM")
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence, fill=Black)) + geom_col(position="dodge") + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("Cumulative Incidence of PCSM") + b.theme + theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("SEER: Interaction Between RT and Race for PCSM")
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence*100, fill=Black)) + geom_col(position="dodge") + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("Cumulative Incidence of PCSM (%)") + b.theme + theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("SEER: Interaction Between RT and Race for PCSM")
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence*100, fill=Black)) + geom_col(position="dodge") + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("5-Year Cumulative Incidence of PCSM (%)") + b.theme + theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("SEER: Interaction Between RT and Race on 5-Year PCSM, Adjusting for Age, Yost, and Insurance Status")
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence*100, fill=Black)) + geom_col(position="dodge", width=0.5) + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("5-Year Cumulative Incidence of PCSM (%)") + b.theme + theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("SEER: Interaction Between RT and Race on 5-Year PCSM, Adjusting for Age, Yost, and Insurance Status")
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence*100, fill=Black)) + geom_col(position="dodge", width=0.75) + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("5-Year Cumulative Incidence of PCSM (%)") + b.theme + theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("SEER: Interaction Between RT and Race on 5-Year PCSM, Adjusting for Age, Yost, and Insurance Status")
int_plot
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence*100, fill=Black)) + geom_col(position="dodge", width=0.65) + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("5-Year Cumulative Incidence of PCSM (%)") + b.theme + theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("SEER: Interaction Between RT and Race on 5-Year PCSM, Adjusting for Age, Yost, and Insurance Status")
int_plot
ggsave("seer_interaction.pdf", int_plot, width=8, height=8)
int_plot <- ggplot(data=pcsm_5yr_dat, aes(x=RT, y=Incidence*100, fill=Black)) + geom_col(position="dodge", width=0.6) + scale_fill_manual("Self-reported race", values = c("gray74", "mediumpurple4")) + xlab('') + ylab("5-Year Cumulative Incidence of PCSM (%)") + b.theme + theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("SEER: Interaction Between RT and Race on 5-Year PCSM, \n Adjusting for Age, Yost, and Insurance Status")
int_plot
ggsave("seer_interaction.pdf", int_plot, width=8, height=12)
ggsave("seer_interaction.pdf", int_plot, width=8, height=4)
ggsave("seer_interaction.pdf", int_plot, width=8, height=6)
racedata <- read_csv("~/Box/RTOG Data and Code/rtog.csv")
#Weights are built using predictors of Gleason, T-stage, Zubrod, age, treatment, baseline PSA, and a risk metric
lcprog<-survfit(Surv(racedata$phoenix_failure_days/365.25, racedata$phoenix_failure, type="mstate")~racedata$race.2,weight=racedata$weights_sumn)
cumulative_grp <- data.frame("surv" = lcprog$pstate[,1], "strata" = c(rep(0, 3044), rep(1, 1009)), "time" = lcprog$time, "ngrp" = rep(2, 4053), "se" = lcprog$std.err[,1], "lower" = lcprog$lower[,1], "upper"=lcprog$upper[,1])
lev.surv <- cut(racedata$phoenix_failure_days/365.25, seq(0, max(racedata$phoenix_failure_days/365.25,na.rm=T)+5, by=5))
risksets <- matrix(rep(0,2*5),nrow=2)
for(i in 1:dim(racedata)[1]){
if(racedata$race.2[i] == 0){
risksets[1,as.numeric(lev.surv[i])]<-risksets[1,as.numeric(lev.surv[i])]+racedata$weights_sumn[i]
}
if(racedata$race.2[i] == 1){
risksets[2,as.numeric(lev.surv[i])]<-risksets[2,as.numeric(lev.surv[i])]+racedata$weights_sumn[i]
}
}
number.at.risk <- sapply(1:nrow(risksets), function(i) Reduce("-",  risksets[i,], init=rowSums(risksets)[i], accumulate=TRUE))
risk_frame <- data.frame("strata" = c(rep(0, 5), rep(1, 5)), "time" = rep(c(0, 5, 10, 15, 20), 2), "n.risk" = c(round(number.at.risk[1:5,1]), round(number.at.risk[1:5,2])))
surv <- matrix(NA, 10, 1)
upper <- matrix(NA, 10, 1)
lower <- matrix(NA, 10, 1)
black <- cumulative_grp[cumulative_grp$strata==1,]
white <- cumulative_grp[cumulative_grp$strata==0,]
for (i in seq(0, 20, by=5)){
surv[(i+5)/5] <- white$surv[which.min(abs(white$time-i))]
surv[(i+30)/5] <- black$surv[which.min(abs(black$time-i))]
upper[(i+5)/5] <- white$upper[which.min(abs(white$time-i))]
upper[(i+30)/5] <- black$upper[which.min(abs(black$time-i))]
lower[(i+5)/5] <- white$lower[which.min(abs(white$time-i))]
lower[(i+30)/5] <- black$lower[which.min(abs(black$time-i))]
}
event_frame <- data.frame("strata" = c(rep(0, 5), rep(1, 5)), "time" = rep(c(0, 5, 10, 15, 20), 2), "surv" = surv, "upper" = upper, "lower" = lower)
n_groups <- 2
b.theme <- theme_minimal(base_size = 15)
col.labels <- c("non-AfA", "AfA")
time.seq <- seq(0, 20, by=5)
xlim <- range(time.seq)
ylim <- c(0, 75)
n.xy <- c(xlim[2], ylim[2]*0.95)
pval.xy <- c(xlim[2], ylim[2])
event.ndigit <- paste0("%.", 1, "f%%")
cumulative_grp$strata <- factor(cumulative_grp$strata)
plot.frame <- ggplot() + geom_step(data = cumulative_grp, aes(x = time, y = surv*100,
group = strata, colour = strata, linetype = strata), size = 1,
direction = "hv", alpha = 1) + scale_color_manual("Group",
values = c("gray74", "mediumpurple4"), labels = col.labels) +
scale_linetype_manual(values = rep(1, n_groups))  + scale_x_continuous("Time (Years)",
limits = xlim, breaks = time.seq, labels = time.seq) + scale_y_continuous("Risk (%)",
limits = ylim) + b.theme + guides(fill = FALSE, linetype = FALSE) +
theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("RTOG: Cumulative Incidence of Biochemical Recurrence")
risk_frame$strata <- factor(risk_frame$strata, labels = c("non-AfA", "AfA"))
risk.data.table <- ggplot(risk_frame, aes(x = time, y = fct_rev(strata), label = format(n.risk, nsmall = 0))) + geom_text(size = 5, hjust = 0.5) +
theme_bw(base_size = 15) + scale_x_continuous("Number of patients at risk", limits = xlim) + theme(axis.title.x = element_text(size = 12, vjust = 1),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border = element_blank(),
axis.text.x = element_blank(),
axis.ticks = element_blank(),
axis.text.y = element_text(face = "bold", hjust = 1, color = c("mediumpurple4", "gray74")),
legend.position = "none") +
xlab(NULL) + ylab(NULL)
event_frame$prop <- ifelse(is.na(event_frame$surv), "", sprintf(paste0(event.ndigit), event_frame$surv))
event_frame$strata <- factor(event_frame$strata, labels = c("non-AfA", "AfA"))
event_frame <- event_frame[event_frame$time != 0, ]
event.data.table <- ggplot(event_frame, aes(x = time, y = fct_rev(strata), label = format(prop, nsmall = 0))) + geom_text(size = 5, hjust = 0.5) +
theme_bw(base_size = 15) + scale_x_continuous("Event rate", limits = xlim) +
theme(axis.title.x = element_text(size = 12, vjust = 1),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border = element_blank(),
axis.text.x = element_blank(),
axis.ticks = element_blank(),
axis.text.y = element_text(face = "bold", hjust = 1, color = c("mediumpurple4", "gray74")),
legend.position = "none")  +
xlab(NULL) + ylab(NULL)
plot_grid(plot.frame, risk.data.table, ncol = 1, align = "v", rel_heights = c(5.6, 2.2))
View(cumulative_grp)
ylim <- c(0, 100)
n.xy <- c(xlim[2], ylim[2]*0.95)
pval.xy <- c(xlim[2], ylim[2])
event.ndigit <- paste0("%.", 1, "f%%")
cumulative_grp$strata <- factor(cumulative_grp$strata)
plot.frame <- ggplot() + geom_step(data = cumulative_grp, aes(x = time, y = surv*100,
group = strata, colour = strata, linetype = strata), size = 1,
direction = "hv", alpha = 1) + scale_color_manual("Group",
values = c("gray74", "mediumpurple4"), labels = col.labels) +
scale_linetype_manual(values = rep(1, n_groups))  + scale_x_continuous("Time (Years)",
limits = xlim, breaks = time.seq, labels = time.seq) + scale_y_continuous("Risk (%)",
limits = ylim) + b.theme + guides(fill = FALSE, linetype = FALSE) +
theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("RTOG: Cumulative Incidence of Biochemical Recurrence")
plot.frame
plot.frame <- ggplot() + geom_step(data = cumulative_grp, aes(x = time, y = (1-surv)*100,
group = strata, colour = strata, linetype = strata), size = 1,
direction = "hv", alpha = 1) + scale_color_manual("Group",
values = c("gray74", "mediumpurple4"), labels = col.labels) +
scale_linetype_manual(values = rep(1, n_groups))  + scale_x_continuous("Time (Years)",
limits = xlim, breaks = time.seq, labels = time.seq) + scale_y_continuous("Risk (%)",
limits = ylim) + b.theme + guides(fill = FALSE, linetype = FALSE) +
theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("RTOG: Cumulative Incidence of Biochemical Recurrence")
plot.frame
test <- lgprog$pstate
test <- lcprog$pstate
View(test)
test2 <- lcprog$std.err
View(test2)
cumulative_grp <- data.frame("surv" = lcprog$pstate[,3], "strata" = c(rep(0, 3044), rep(1, 1009)), "time" = lcprog$time, "ngrp" = rep(2, 4053), "se" = lcprog$std.err[,3], "lower" = lcprog$lower[,3], "upper"=lcprog$upper[,3])
lev.surv <- cut(racedata$phoenix_failure_days/365.25, seq(0, max(racedata$phoenix_failure_days/365.25,na.rm=T)+5, by=5))
risksets <- matrix(rep(0,2*5),nrow=2)
for(i in 1:dim(racedata)[1]){
if(racedata$race.2[i] == 0){
risksets[1,as.numeric(lev.surv[i])]<-risksets[1,as.numeric(lev.surv[i])]+racedata$weights_sumn[i]
}
if(racedata$race.2[i] == 1){
risksets[2,as.numeric(lev.surv[i])]<-risksets[2,as.numeric(lev.surv[i])]+racedata$weights_sumn[i]
}
}
number.at.risk <- sapply(1:nrow(risksets), function(i) Reduce("-",  risksets[i,], init=rowSums(risksets)[i], accumulate=TRUE))
risk_frame <- data.frame("strata" = c(rep(0, 5), rep(1, 5)), "time" = rep(c(0, 5, 10, 15, 20), 2), "n.risk" = c(round(number.at.risk[1:5,1]), round(number.at.risk[1:5,2])))
surv <- matrix(NA, 10, 1)
upper <- matrix(NA, 10, 1)
lower <- matrix(NA, 10, 1)
black <- cumulative_grp[cumulative_grp$strata==1,]
white <- cumulative_grp[cumulative_grp$strata==0,]
for (i in seq(0, 20, by=5)){
surv[(i+5)/5] <- white$surv[which.min(abs(white$time-i))]
surv[(i+30)/5] <- black$surv[which.min(abs(black$time-i))]
upper[(i+5)/5] <- white$upper[which.min(abs(white$time-i))]
upper[(i+30)/5] <- black$upper[which.min(abs(black$time-i))]
lower[(i+5)/5] <- white$lower[which.min(abs(white$time-i))]
lower[(i+30)/5] <- black$lower[which.min(abs(black$time-i))]
}
event_frame <- data.frame("strata" = c(rep(0, 5), rep(1, 5)), "time" = rep(c(0, 5, 10, 15, 20), 2), "surv" = surv, "upper" = upper, "lower" = lower)
n_groups <- 2
b.theme <- theme_minimal(base_size = 15)
col.labels <- c("non-AfA", "AfA")
time.seq <- seq(0, 20, by=5)
xlim <- range(time.seq)
ylim <- c(0, 100)
n.xy <- c(xlim[2], ylim[2]*0.95)
pval.xy <- c(xlim[2], ylim[2])
event.ndigit <- paste0("%.", 1, "f%%")
cumulative_grp$strata <- factor(cumulative_grp$strata)
plot.frame <- ggplot() + geom_step(data = cumulative_grp, aes(x = time, y = surv*100,
group = strata, colour = strata, linetype = strata), size = 1,
direction = "hv", alpha = 1) + scale_color_manual("Group",
values = c("gray74", "mediumpurple4"), labels = col.labels) +
scale_linetype_manual(values = rep(1, n_groups))  + scale_x_continuous("Time (Years)",
limits = xlim, breaks = time.seq, labels = time.seq) + scale_y_continuous("Risk (%)",
limits = ylim) + b.theme + guides(fill = FALSE, linetype = FALSE) +
theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("RTOG: Cumulative Incidence of Biochemical Recurrence")
plot.frame
cumulative_grp <- data.frame("surv" = lcprog$pstate[,2], "strata" = c(rep(0, 3044), rep(1, 1009)), "time" = lcprog$time, "ngrp" = rep(2, 4053), "se" = lcprog$std.err[,2], "lower" = lcprog$lower[,3], "upper"=lcprog$upper[,2])
lev.surv <- cut(racedata$phoenix_failure_days/365.25, seq(0, max(racedata$phoenix_failure_days/365.25,na.rm=T)+5, by=5))
risksets <- matrix(rep(0,2*5),nrow=2)
for(i in 1:dim(racedata)[1]){
if(racedata$race.2[i] == 0){
risksets[1,as.numeric(lev.surv[i])]<-risksets[1,as.numeric(lev.surv[i])]+racedata$weights_sumn[i]
}
if(racedata$race.2[i] == 1){
risksets[2,as.numeric(lev.surv[i])]<-risksets[2,as.numeric(lev.surv[i])]+racedata$weights_sumn[i]
}
}
number.at.risk <- sapply(1:nrow(risksets), function(i) Reduce("-",  risksets[i,], init=rowSums(risksets)[i], accumulate=TRUE))
risk_frame <- data.frame("strata" = c(rep(0, 5), rep(1, 5)), "time" = rep(c(0, 5, 10, 15, 20), 2), "n.risk" = c(round(number.at.risk[1:5,1]), round(number.at.risk[1:5,2])))
surv <- matrix(NA, 10, 1)
upper <- matrix(NA, 10, 1)
lower <- matrix(NA, 10, 1)
black <- cumulative_grp[cumulative_grp$strata==1,]
white <- cumulative_grp[cumulative_grp$strata==0,]
for (i in seq(0, 20, by=5)){
surv[(i+5)/5] <- white$surv[which.min(abs(white$time-i))]
surv[(i+30)/5] <- black$surv[which.min(abs(black$time-i))]
upper[(i+5)/5] <- white$upper[which.min(abs(white$time-i))]
upper[(i+30)/5] <- black$upper[which.min(abs(black$time-i))]
lower[(i+5)/5] <- white$lower[which.min(abs(white$time-i))]
lower[(i+30)/5] <- black$lower[which.min(abs(black$time-i))]
}
event_frame <- data.frame("strata" = c(rep(0, 5), rep(1, 5)), "time" = rep(c(0, 5, 10, 15, 20), 2), "surv" = surv, "upper" = upper, "lower" = lower)
n_groups <- 2
b.theme <- theme_minimal(base_size = 15)
col.labels <- c("non-AfA", "AfA")
time.seq <- seq(0, 20, by=5)
xlim <- range(time.seq)
ylim <- c(0, 100)
n.xy <- c(xlim[2], ylim[2]*0.95)
pval.xy <- c(xlim[2], ylim[2])
event.ndigit <- paste0("%.", 1, "f%%")
cumulative_grp$strata <- factor(cumulative_grp$strata)
plot.frame <- ggplot() + geom_step(data = cumulative_grp, aes(x = time, y = surv*100,
group = strata, colour = strata, linetype = strata), size = 1,
direction = "hv", alpha = 1) + scale_color_manual("Group",
values = c("gray74", "mediumpurple4"), labels = col.labels) +
scale_linetype_manual(values = rep(1, n_groups))  + scale_x_continuous("Time (Years)",
limits = xlim, breaks = time.seq, labels = time.seq) + scale_y_continuous("Risk (%)",
limits = ylim) + b.theme + guides(fill = FALSE, linetype = FALSE) +
theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("RTOG: Cumulative Incidence of Biochemical Recurrence")
plot.frame
ylim <- c(0, 75)
n.xy <- c(xlim[2], ylim[2]*0.95)
pval.xy <- c(xlim[2], ylim[2])
event.ndigit <- paste0("%.", 1, "f%%")
cumulative_grp$strata <- factor(cumulative_grp$strata)
plot.frame <- ggplot() + geom_step(data = cumulative_grp, aes(x = time, y = surv*100,
group = strata, colour = strata, linetype = strata), size = 1,
direction = "hv", alpha = 1) + scale_color_manual("Group",
values = c("gray74", "mediumpurple4"), labels = col.labels) +
scale_linetype_manual(values = rep(1, n_groups))  + scale_x_continuous("Time (Years)",
limits = xlim, breaks = time.seq, labels = time.seq) + scale_y_continuous("Risk (%)",
limits = ylim) + b.theme + guides(fill = FALSE, linetype = FALSE) +
theme(legend.position = c(0.1, 0.9), legend.justification = c(0.1, 0.9), legend.background= element_rect(fill = c(0, 0))) + ggtitle("RTOG: Cumulative Incidence of Biochemical Recurrence")
risk_frame$strata <- factor(risk_frame$strata, labels = c("non-AfA", "AfA"))
risk.data.table <- ggplot(risk_frame, aes(x = time, y = fct_rev(strata), label = format(n.risk, nsmall = 0))) + geom_text(size = 5, hjust = 0.5) +
theme_bw(base_size = 15) + scale_x_continuous("Number of patients at risk", limits = xlim) + theme(axis.title.x = element_text(size = 12, vjust = 1),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border = element_blank(),
axis.text.x = element_blank(),
axis.ticks = element_blank(),
axis.text.y = element_text(face = "bold", hjust = 1, color = c("mediumpurple4", "gray74")),
legend.position = "none") +
xlab(NULL) + ylab(NULL)
event_frame$prop <- ifelse(is.na(event_frame$surv), "", sprintf(paste0(event.ndigit), event_frame$surv))
event_frame$strata <- factor(event_frame$strata, labels = c("non-AfA", "AfA"))
event_frame <- event_frame[event_frame$time != 0, ]
event.data.table <- ggplot(event_frame, aes(x = time, y = fct_rev(strata), label = format(prop, nsmall = 0))) + geom_text(size = 5, hjust = 0.5) +
theme_bw(base_size = 15) + scale_x_continuous("Event rate", limits = xlim) +
theme(axis.title.x = element_text(size = 12, vjust = 1),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border = element_blank(),
axis.text.x = element_blank(),
axis.ticks = element_blank(),
axis.text.y = element_text(face = "bold", hjust = 1, color = c("mediumpurple4", "gray74")),
legend.position = "none")  +
xlab(NULL) + ylab(NULL)
plot_grid(plot.frame, risk.data.table, ncol = 1, align = "v", rel_heights = c(5.6, 2.2))
ggsave("bcr_rtog.pdf", plot_grid(plot.frame, risk.data.table, ncol = 1, align = "v", rel_heights = c(5.6, 2.2)), width=8, height=8)
